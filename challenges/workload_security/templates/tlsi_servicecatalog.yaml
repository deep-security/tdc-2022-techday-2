import json, boto3, requests, re

def lambda_handler(event, context):

    ssmcliant = boto3.client('ssm')
    api_key = ssmcliant.get_parameter(Name='/player/C1/c1ApiKey')["Parameter"]["Value"]
    region = ssmcliant.get_parameter(Name='/player/C1/c1Region')["Parameter"]["Value"]

    ec2 = boto3.client('ec2')
    ec2_data = ec2.describe_instances(
    Filters=[
    {
      'Name': 'tag:Name',
      'Values': ['koshida-test-td']
    }
            ]
    )
    
    for ec2_reservation in ec2_data['Reservations']:
        for ec2_instance in ec2_reservation['Instances']:
            ec2_instance_id = ec2_instance['InstanceId']
            ec2_instance_type = ec2_instance['InstanceType']
            ec2_instance_state = ec2_instance['State']['Name']
    
    print(ec2_instance_id + ',' + ec2_instance_type + ',' + ec2_instance_state)

    authorization = "ApiKey " + api_key
    BaseURL = "https://workload." + region + ".cloudone.trendmicro.com/api/agentdeploymentscripts"
        
    json_data = {
        "platform": "linux",
        "validateCertificateRequired": "true",
        "validateDigitalSignatureRequired": "false",
        "activationRequired": "true"
    }    
        
    headers = {'Content-Type': 'application/json', 'api-version': 'v1', 'Authorization': authorization}
    result = requests.post(BaseURL, headers=headers, data = json.dumps(json_data))
    dict_result = json.loads(result.text)
    script = dict_result['scriptBody']
    
    activate_comand = "/opt/ds_agent/dsa_control -a dsm://agents.workload.trend-us-1.cloudone.trendmicro.com:443/ "
    tenantid_and_token = script.split()
    tenantid = tenantid_and_token[-2]
    token = tenantid_and_token[-1]
    activationcode = activate_comand + tenantid + " " + token
    
    #print(activationcode)
    
    
    response = ssmcliant.send_command(
        InstanceIds = [ec2_instance_id],
        DocumentName = "AWS-RunShellScript",
        Parameters = {
            "commands": [activationcode]
        },
    )
    print(response)
    
