AWSTemplateFormatVersion: 2010-09-09
Description: Template for TD-koshida
Parameters:
  KeyName:
    Description: Name of an existing EC2 KeyPair to enable SSH access to the instance
    Type: 'AWS::EC2::KeyPair::KeyName'
    ConstraintDescription: must be the name of an existing EC2 KeyPair.
    Default: sdc1-koshida-key
  InstanceType:
    Description: WebServer EC2 instance type
    Type: String
    Default: t2.medium
    ConstraintDescription: must be a valid EC2 instance type.
Resources:
  EC2Instance:
    Type: 'AWS::EC2::Instance'
    Properties:
      ImageId: ami-02c3627b04781eada
      InstanceType: !Ref InstanceType
      SubnetId: subnet-056bdee5d5bc80c87
      Tags: 
      - Key: Project
        Value: TD
      - Key: Name
        Value: koshida-test-td
      IamInstanceProfile: EC2-ssm
      SecurityGroupIds:
        - sg-034842fcef1ed58fb
      UserData: 
        Fn::Base64: !Sub |
          #!/bin/bash
          yum update -y
          yum install -y httpd
          systemctl start httpd
          systemctl enable httpd
          echo "Hello World from user data" > /var/www/html/index.html
          sudo yum install -y mod_ssl
          cd /etc/pki/tls/certs
          sudo ./make-dummy-cert localhost.crt
          sed -i 's/SSLProtocol\s/all\s/-SSLv3/SSLProtocol\s/-all\s/+TLSv1.2/g' /etc/httpd/conf.d/ssl.conf
          sed -i 's/SSLCertificateKeyFile\s\/etc\/pki\/tls\/private\/localhost.key/#SSLCertificateKeyFile\s\/etc\/pki\/tls\/private\/localhost.key/g' /etc/httpd/conf.d/ssl.conf
          public_host_name=`curl http://169.254.169.254/latest/meta-data/public-hostname`
          sed -i "6i DocumentRoot /var/www/html" /etc/httpd/conf.d/ssl.conf
          sed -i "7i ServerName $public_host_name" /etc/httpd/conf.d/ssl.conf
          sudo systemctl restart httpd
          curl -OL https://workload.trend-us-1.cloudone.trendmicro.com:443/software/agent/amzn2/x86_64/20.0.0.3770/agent.rpm
          sudo rpm -i agent.rpm
Outputs:
  InstanceId:
    Description: InstanceId of the newly created EC2 instance
    Value:
      Ref: EC2Instance
  AZ:
    Description: Availability Zone of the newly created EC2 instance
    Value:
      'Fn::GetAtt':
        - EC2Instance
        - AvailabilityZone
  PublicDNS:
    Description: Public DNSName of the newly created EC2 instance
    Value:
      'Fn::GetAtt':
        - EC2Instance
        - PublicDnsName
  PublicIP:
    Description: Public IP address of the newly created EC2 instance
    Value:
      'Fn::GetAtt':
        - EC2Instance
        - PublicIp

