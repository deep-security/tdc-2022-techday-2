AWSTemplateFormatVersion: 2010-09-09
Description: tdc-2022-techday-2 Cloud One File Storage Security and Conformity main template

Parameters:
  ChallengeBucket:
    AllowedPattern: ^[0-9a-zA-Z-/._]*$
    Default: ""
    Description: Bucket that contains challenge code.
    Type: String
  ChallengeRoot:
    Default: "challenges/file_storage_security"
    Description: Root folder for this challenge.
    Type: String

  # Lambda Code parameters
  LambdaCodeBucket:
    Default: ""
    Description: Bucket where all the Lambda code resides (generated by CopyZips in the entrypoint template).
    Type: String

  ConformityCustomCheckCode:
    Default: ""
    Type: String

Resources:
  ConformityCustomCheck:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket: !Ref LambdaCodeBucket
        S3Key: !Sub '${ChallengeRoot}${ConformityCustomCheckCode}'
      Handler: index.handler
      Role: !GetAtt ConformityCustomCheckRole.Arn
      Runtime: python3.9

  ConformityCustomCheckRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: "2012-10-17"
      ManagedPolicyArns:
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              # FIXME change to be less permissive
              - :iam::aws:policy/AmazonS3FullAccess
