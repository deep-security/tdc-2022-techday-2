AWSTemplateFormatVersion: "2010-09-09"
Description: Deploys EKS nodes into an existing VPC (qs-1p7nknoid)
Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: Network configuration
        Parameters:
          - Subnet1ID
          - Subnet2ID
          - Subnet3ID
      - Label:
          default: Amazon EC2 configuration
        Parameters:
          - CreateNodeGroup
          - KeyPairName
          - NodeGroupOS
          - HttpProxy
          - CustomAmiId
      - Label:
          default: EKS configuration
        Parameters:
          - EKSClusterName
          - NodeInstanceType
          - NumberOfNodes
          - MaxNumberOfNodes
          - NodeGroupName
          - NodeVolumeSize
    ParameterLabels:
      KeyPairName:
        default: SSH key name
      NodeGroupOS:
        default: Node operating system
      Subnet1ID:
        default: Subnet 1 ID
      Subnet2ID:
        default: Subnet 2 ID
      Subnet3ID:
        default: Subnet 3 ID
      EKSClusterName:
        default: EKS cluster name
      NodeInstanceType:
        default: Nodes instance type
      NumberOfNodes:
        default: Number of nodes
      MaxNumberOfNodes:
        default: Maximum number of nodes
      NodeGroupName:
        default: Node group name
      NodeVolumeSize:
        default: Node volume size
      CustomAmiId:
        default: Custom AMI id
      HttpProxy:
        default: HTTP proxy
      CreateNodeGroup:
        default: Create node group
  LintSpellExclude:
    - Managed Node Group
    - files/bootstrap.sh
    - https://github.com/awslabs/amazon-eks-ami
    - autoscaler
    - Lambda
    - Security Group
    - Target Group
    - Kubernetes
    - Instance Profile
    - Role
    - Enabled
    - Disabled
    - Subnet
    - (Optional)
    - Custom
    - Unmanaged
  AutoInstance:
    NodeInstanceType:
      InstanceFilters:
       - [['PV'], "!=", "SupportedVirtualizationTypes"]
  cfn-lint: { config: { ignore_checks: [W2030, W9002, W9003, W9004, E3008, W9006]}}
Parameters:
  KeyPairName:
    Description: Name of an existing EC2 key pair. All instances will launch with this key pair. Ignored if "Custom launch template" is provided. If left blank, no keypair will be associsated with the nodes.
    Type: String
    Default: ""
  NodeGroupOS:
    AllowedValues:
      - 'Amazon Linux 2'
      - 'Bottlerocket'
      - 'Windows'
    Default: 'Amazon Linux 2'
    Description: The Linux distribution for the AMI to be used for the node instances. Ignored if "Custom launch template" is provided.
    Type: String
  CustomAmiId:
    Type: String
    Default: ""
    Description: "(Optional) If an AMI id is specified here it will be used in stead of the ami determined from the OS/region."
  Subnet1ID:
    Description: ID of subnet 1 for the node group (e.g.,subnet-a0246123).
    Type: AWS::EC2::Subnet::Id
  Subnet2ID:
    Description: (Optional) ID of subnet 2 for the node group (e.g.,subnet-b1f432cd). Must be in the same VPC as "Subnet 1 ID."
    Type: String
    Default: ""
  Subnet3ID:
    Description: (Optional) ID of subnet 3 for the node group (e.g.,subnet-b1f4a2cd). Must be in the same VPC as "Subnet 1 ID."
    Type: String
    Default: ""
  NodeInstanceType:
    Default: t3.medium
    AllowedValues: ["t3a.nano", "t3.nano", "t2.nano", "t3a.micro", "t3.micro", "t2.micro", "t3a.small", "t1.micro", "t3.small", "t2.small", "a1.medium", "c6g.medium", "t3a.medium", "c6gd.medium", "m6g.medium", "t3.medium", "m1.small", "m6gd.medium", "t2.medium", "r6g.medium", "a1.large", "r6gd.medium", "m3.medium", "c6g.large", "t3a.large", "c6gd.large", "m6g.large", "c5a.large", "t3.large", "c5.large", "c5ad.large", "m5a.large", "m1.medium", "m6gd.large", "t2.large", "c5d.large", "m5.large", "m4.large", "c4.large", "r6g.large", "a1.xlarge", "m5ad.large", "c3.large", "c5n.large", "r5a.large", "m5d.large", "r6gd.large", "m5n.large", "r5.large", "c1.medium", "r5ad.large", "r4.large", "m3.large", "c6g.xlarge", "m5dn.large", "r5d.large", "r5n.large", "t3a.xlarge", "c6gd.xlarge", "m6g.xlarge", "c5a.xlarge", "i3.large", "r3.large", "t3.xlarge", "r5dn.large", "c5.xlarge", "c5ad.xlarge", "m5a.xlarge", "m1.large", "m6gd.xlarge", "t2.xlarge", "z1d.large", "m5.xlarge", "c5d.xlarge", "c4.xlarge", "m4.xlarge", "r6g.xlarge", "a1.2xlarge", "m5ad.xlarge", "c3.xlarge", "c5n.xlarge", "m5d.xlarge", "r5a.xlarge", "i3en.large", "r6gd.xlarge", "m5n.xlarge", "m2.xlarge", "r5.xlarge", "r5ad.xlarge", "m3.xlarge", "r4.xlarge", "m5dn.xlarge", "c6g.2xlarge", "r5d.xlarge", "r5n.xlarge", "t3a.2xlarge", "c6gd.2xlarge", "c5a.2xlarge", "m6g.2xlarge", "i3.xlarge", "t3.2xlarge", "r3.xlarge", "r5dn.xlarge", "c5.2xlarge", "m5a.2xlarge", "c5ad.2xlarge", "m1.xlarge", "m6gd.2xlarge", "inf1.xlarge", "t2.2xlarge", "z1d.xlarge", "c5d.2xlarge", "m5.2xlarge", "c4.2xlarge", "m4.2xlarge", "r6g.2xlarge", "a1.metal", "a1.4xlarge", "m5ad.2xlarge", "c3.2xlarge", "c5n.2xlarge", "r5a.2xlarge", "i3en.xlarge", "m5d.2xlarge", "r6gd.2xlarge", "h1.2xlarge", "m5n.2xlarge", "m2.2xlarge", "r5.2xlarge", "c1.xlarge", "r5ad.2xlarge", "g4dn.xlarge", "r4.2xlarge", "m3.2xlarge", "m5dn.2xlarge", "c6g.4xlarge", "r5d.2xlarge", "inf1.2xlarge", "r5n.2xlarge", "c6gd.4xlarge", "c5a.4xlarge", "m6g.4xlarge", "i3.2xlarge", "g2.2xlarge", "r3.2xlarge", "r5dn.2xlarge", "c5.4xlarge", "c5ad.4xlarge", "m5a.4xlarge", "d2.xlarge", "m6gd.4xlarge", "z1d.2xlarge", "g3s.xlarge", "g4dn.2xlarge", "m5.4xlarge", "c5d.4xlarge", "c4.4xlarge", "m4.4xlarge", "r6g.4xlarge", "m5ad.4xlarge", "x1e.xlarge", "c3.4xlarge", "i2.xlarge", "c5n.4xlarge", "p2.xlarge", "r5a.4xlarge", "i3en.2xlarge", "m5d.4xlarge", "r6gd.4xlarge", "h1.4xlarge", "m5n.4xlarge", "m2.4xlarge", "r5.4xlarge", "r5ad.4xlarge", "r4.4xlarge", "c6g.8xlarge", "m5dn.4xlarge", "z1d.3xlarge", "g3.4xlarge", "r5d.4xlarge", "r5n.4xlarge", "g4dn.4xlarge", "c6gd.8xlarge", "m6g.8xlarge", "c5a.8xlarge", "i3.4xlarge", "r3.4xlarge", "r5dn.4xlarge", "i3en.3xlarge", "m5a.8xlarge", "c5ad.8xlarge", "d2.2xlarge", "m6gd.8xlarge", "c5.9xlarge", "m5.8xlarge", "c4.8xlarge", "r6g.8xlarge", "c6g.12xlarge", "m5ad.8xlarge", "f1.2xlarge", "x1e.2xlarge", "c3.8xlarge", "i2.2xlarge", "c5d.9xlarge", "m5d.8xlarge", "r5a.8xlarge", "r6gd.8xlarge", "c6gd.12xlarge", "c5a.12xlarge", "m6g.12xlarge", "h1.8xlarge", "m5n.8xlarge", "inf1.6xlarge", "c5n.9xlarge", "i3en.24xlarge", "i3en.metal", "p3.8xlarge", "f1.16xlarge", "x1.32xlarge", "x1e.16xlarge", "p2.16xlarge", "m4.10xlarge", "cc2.8xlarge", "r5.8xlarge", "c5.12xlarge", "c5ad.12xlarge", "m5a.12xlarge", "r5ad.8xlarge", "r4.8xlarge", "m6gd.12xlarge", "m5dn.8xlarge", "c6g.16xlarge", "g4dn.8xlarge", "c6g.metal", "z1d.6xlarge", "g3.8xlarge", "m5.12xlarge", "c5d.12xlarge", "r5d.8xlarge", "r5n.8xlarge", "r6g.12xlarge", "c6gd.metal", "c6gd.16xlarge", "m6g.metal", "c5a.16xlarge", "m6g.16xlarge", "m5ad.12xlarge", "i3.8xlarge", "g2.8xlarge", "r3.8xlarge", "r5dn.8xlarge", "r5a.12xlarge", "m5d.12xlarge", "i3en.6xlarge", "c5ad.16xlarge", "m5a.16xlarge", "d2.4xlarge", "r6gd.12xlarge", "m5n.12xlarge", "m6gd.metal", "m6gd.16xlarge", "p3.16xlarge", "x1e.32xlarge", "r5.12xlarge", "p3.2xlarge", "c5.18xlarge", "m5.16xlarge", "r5ad.12xlarge", "m4.16xlarge", "r6g.16xlarge", "r6g.metal", "m5dn.12xlarge", "m5ad.16xlarge", "f1.4xlarge", "x1e.4xlarge", "i2.4xlarge", "c5d.18xlarge", "r5d.12xlarge", "r5n.12xlarge", "m5d.16xlarge", "r5a.16xlarge", "r6gd.metal", "r6gd.16xlarge", "c5a.24xlarge", "h1.16xlarge", "m5n.16xlarge", "c5n.18xlarge", "c5n.metal", "g4dn.12xlarge", "p3dn.24xlarge", "r5dn.12xlarge", "r5.16xlarge", "c5.metal", "c5.24xlarge", "c5ad.24xlarge", "m5a.24xlarge", "r5ad.16xlarge", "r4.16xlarge", "m5dn.16xlarge", "g4dn.16xlarge", "z1d.metal", "z1d.12xlarge", "g3.16xlarge", "m5.24xlarge", "m5.metal", "c5d.24xlarge", "r5d.16xlarge", "c5d.metal", "r5n.16xlarge", "m5ad.24xlarge", "i3.metal", "i3.16xlarge", "r5dn.16xlarge", "m5d.metal", "i3en.12xlarge", "m5d.24xlarge", "r5a.24xlarge", "d2.8xlarge", "m5n.24xlarge", "r5.24xlarge", "r5.metal", "r5ad.24xlarge", "m5dn.24xlarge", "x1.16xlarge", "x1e.8xlarge", "i2.8xlarge", "r5d.24xlarge", "r5d.metal", "r5n.24xlarge", "p2.8xlarge", "inf1.24xlarge", "g4dn.metal", "r5dn.24xlarge", "t4g.nano", "t4g.medium", "t4g.large", "t4g.micro", "t4g.small", "t4g.2xlarge", "t4g.xlarge"]
    ConstraintDescription: Must be a valid EC2 instance type
    Description: Type of EC2 instance for the node instances.
    Type: String
  NodeInstanceType2:
    Default: ""
    Description: (Optional) Only applies if "Node group type" is set to "Unmanaged." 2nd type of EC2 instance for the node instances.
    Type: String
  NodeInstanceType3:
    Default: ""
    Description: (Optional) Only applies if "Node group type" is set to "Unmanaged." 3rd type of EC2 instance for the node instances.
    Type: String
  NodeInstanceType4:
    Default: ""
    Description: (Optional) Only applies if "Node group type" is set to "Unmanaged." 4th type of EC2 instance for the node instances.
    Type: String
  NumberOfNodes:
    Default: 3
    Description: Number of EKS node instances.
    Type: Number
  MaxNumberOfNodes:
    Default: ""
    Description: "(Optional) The maximum number of Amazon EKS node instances, if left blank will be set to the same value as NumberOfNodes."
    Type: String
  NodeGroupName:
    Default: Default
    Description: Name for EKS node group.
    Type: String
  NodeVolumeSize:
    Default: 20
    Description: Size for node volumes.
    Type: String
  EKSClusterName:
    Description: Name of the EKS cluster to join.
    Type: String
  HttpProxy:
    Type: String
    Default: ""
    Description: (Optional) Specify the host name for an HTTP proxy to use for outbound internet access.
  NodeGroupType:
    Type: String
    AllowedValues: [ Managed, Unmanaged ]
    Default: Managed
    Description: Choose "Unmanaged" to create an auto-scaling group without using the EKS managed node groups feature.
  NodeInstanceFamily:
    AllowedValues: ['Standard', 'ARM', 'GPU']
    Type: String
    Default: 'Standard'
    Description: Choose "ARM" to use an ARM based AMI, choose "GPU" to use an AMI that supports GPU and Inferentia based instance types. Ignored if "Custom launch template" is provided.
  LaunchTemplateId:
    Default: ""
    Type: String
    Description: (Optional) ID of an existing launch template to use when creating the node group.
  LaunchTemplateVersion:
    Default: ""
    Type: String
    Description: Must be specified if "Launch template ID" is provided. Cannot be "$Latest" or "$Default". This valiue sets the launch template version for the node group to use.
  Labels:
    Default: ""
    Type: String
    Description: (Optional) Comma separated list of <key>=<value> pairs representing node labels to assign to the node group. Ignored if "Custom launch template" is provided.
  Taints:
    Default: ""
    Type: String
    Description: (Optional) Comma separated list of <key>=<value>:<effect> representing node taints to assign to the node group. Ignored if "Custom launch template" is provided.
  NodeSecurityGroupId:
    Default: ""
    Type: String
    Description: (Optional) Provide the id of a Security Group to use for this node group. If not specified, the cluster Security Group will be used.
  OndemandPercentage:
    Default: 100
    Type: Number
    Description: Only applies if "Node group type" is set to "Unmanaged." Set the percentage of on demand Instances and spot instances. With the default of 100, the percentages are 100% for on demand instances and 0% for spot instances.
  CreateNodeGroup:
    Type: String
    Default: 'Yes'
    AllowedValues: ['Yes', 'No']
    Description: If 'No' the stack will create just the Security Group skipping the node group. This is useful if you manage the node group with third party integration, such as Spot.io
  WindowsEdition:
    Type: String
    AllowedValues: [Core, Full]
    Default: Core
    Description: 'The edition of Windows AMI to use for Windows Nodegroups.'
  WindowsVersion:
    Type: String
    AllowedValues: ['2004', '2019']
    Default: '2004'
    Description: 'The version of windows to use for Windows Nodegroups.'
  EC2MetadataPutResponseHopLimit:
    Type: String
    Default: "1"
    Description: The desired HTTP PUT response hop limit for instance metadata requests. The larger the number, the further instance metadata requests can travel.
  EC2MetadataHttpTokens:
    Type: String
    AllowedValues: [optional, required]
    Default: optional
    Description: >
      If set to "optional" pods will be able to use the node's IAM instance profile.
      If set to "required" amd "EC2MetadataPutResponseHopLimit" is set to 1, pods will not be able to access the nodes IAM role.
      If set to "required" amd "EC2MetadataPutResponseHopLimit" is set greater than 1 pods must send a signed token header with any instance metadata retrieval requests.
      NOTE: This will default to "required" in the next major release.
Conditions:
  IsAL2: !Equals [!Ref NodeGroupOS, 'Amazon Linux 2']
  IsWindows: !Equals [!Ref NodeGroupOS, 'Windows']
  IsManaged: !Equals [!Ref NodeGroupType, Managed]
  IsUnmanaged: !Equals [!Ref NodeGroupType, Unmanaged]
  IsArm: !Equals [!Ref NodeInstanceFamily, "ARM"]
  IsGpu: !Equals [!Ref NodeInstanceFamily, "GPU"]
  UseClusterNodeSecurityGroup: !Equals [!Ref NodeSecurityGroupId, ""]
  MaxNodesDefined: !Not [!Equals [!Ref MaxNumberOfNodes, ""]]
  1Type: !Equals [!Ref NodeInstanceType2, ""]
  2Type: !Not [!Equals [!Ref NodeInstanceType2, ""]]
  3Type: !Not [!Equals [!Ref NodeInstanceType3, ""]]
  4Type: !Not [!Equals [!Ref NodeInstanceType4, ""]]
  CreateLaunchTemplate: !Equals [!Ref LaunchTemplateId, ""]
  3AZDeployment: !Not [!Equals [!Ref Subnet3ID, ""]]
  2AZDeployment: !Not [!Equals [!Ref Subnet2ID, ""]]
  IsSingleInstance: !Equals [!Ref NumberOfNodes, 1]
  EnableProxy: !Not [!Equals [!Ref HttpProxy, ""]]
  AddExtraArgs: !Or [!Not [ !Equals [ !Ref Labels, "" ] ], !Not [ !Equals [ !Ref Taints, "" ] ]]
  AddLabels: !Not [ !Equals [ !Ref Labels, "" ] ]
  AddTaints: !Not [ !Equals [ !Ref Taints, "" ] ]
  IsBottlerocket: !Equals [ !Ref NodeGroupOS, "Bottlerocket" ]
  UseCustomAmi: !Not [ !Equals [ !Ref CustomAmiId, "" ] ]
  UseSSmAmi: !Equals [ !Ref CustomAmiId, "" ]
  CreateNodeGroup: !Equals [ !Ref CreateNodeGroup, 'Yes' ]
  CreateManagedNodeGroup: !And [ !Condition IsManaged, !Condition CreateNodeGroup ]
  CreateUnmanagedNodeGroup: !And [ !Condition IsUnmanaged, !Condition CreateNodeGroup ]
  UseKeyPair: !Not [ !Equals [ !Ref KeyPairName, "" ] ]
Mappings:
  Config:
    Prefix: { Value: 'eks-quickstart' }
Resources:
  VPCID:
    Type: Custom::CliQuery
    Properties:
      ServiceToken: !Sub ['arn:${AWS::Partition}:lambda:${AWS::Region}:${AWS::AccountId}:function:${Prefix}-ResourceReader', {Prefix: !FindInMap [Config, Prefix, Value]}]
      AwsCliCommand: !Sub "ec2 describe-subnets --subnet-ids ${Subnet1ID} --query 'Subnets[0].{VpcId: VpcId}'"
      IdField: 'VpcId'
  VPCCIDR:
    Type: Custom::CliQuery
    Properties:
      ServiceToken: !Sub ['arn:${AWS::Partition}:lambda:${AWS::Region}:${AWS::AccountId}:function:${Prefix}-ResourceReader', {Prefix: !FindInMap [Config, Prefix, Value]}]
      AwsCliCommand: !Sub "ec2 describe-vpcs --vpc-id ${VPCID} --query 'Vpcs[0].{CidrBlock: CidrBlock}'"
      IdField: 'CidrBlock'
  NodeRoleArn:
    Type: Custom::CliQuery
    Properties:
      ServiceToken: !Sub ['arn:${AWS::Partition}:lambda:${AWS::Region}:${AWS::AccountId}:function:${Prefix}-ResourceReader', {Prefix: !FindInMap [Config, Prefix, Value]}]
      AwsCliCommand: !Sub
        - "iam get-role --role-name ${NodeInstanceRoleName} --query 'Role'"
        - NodeInstanceRoleName: !Sub
          - '${Prefix}-${Suffix}'
          - Prefix: !FindInMap [Config, Prefix, Value]
            Suffix: !If [IsManaged, 'ManagedNodeInstance', 'UnmanagedNodeInstance']
      IdField: 'Arn'
  NodeInstanceProfileArn:
    Condition: IsUnmanaged
    Type: Custom::CliQuery
    Properties:
      ServiceToken: !Sub ['arn:${AWS::Partition}:lambda:${AWS::Region}:${AWS::AccountId}:function:${Prefix}-ResourceReader', {Prefix: !FindInMap [Config, Prefix, Value]}]
      AwsCliCommand: !Sub
        - "iam list-instance-profiles --query 'InstanceProfiles[].{role: Roles[0].RoleName, arn: Arn}[?role==`${NodeInstanceRoleName}`] | [0]'"
        - NodeInstanceRoleName: !Sub
          - '${Prefix}-${Suffix}'
          - Prefix: !FindInMap [Config, Prefix, Value]
            Suffix: !If [IsManaged, 'ManagedNodeInstance', 'UnmanagedNodeInstance']
      IdField: 'arn'
  ClusterEndpoint:
    Type: Custom::CliQuery
    Properties:
      ServiceToken: !Sub ['arn:${AWS::Partition}:lambda:${AWS::Region}:${AWS::AccountId}:function:${Prefix}-ResourceReader', {Prefix: !FindInMap [Config, Prefix, Value]}]
      AwsCliCommand: !Sub "eks describe-cluster --name ${EKSClusterName} --query '{Endpoint: cluster.endpoint, CaData: cluster.certificateAuthority.data}'"
      IdField: 'Endpoint'
  ClusterNodeSecurityGroup:
    Type: Custom::CliQuery
    Properties:
      ServiceToken: !Sub ['arn:${AWS::Partition}:lambda:${AWS::Region}:${AWS::AccountId}:function:${Prefix}-ResourceReader', {Prefix: !FindInMap [Config, Prefix, Value]}]
      AwsCliCommand: !Sub "eks describe-cluster --name ${EKSClusterName} --query '{SGID: cluster.resourcesVpcConfig.clusterSecurityGroupId}'"
      IdField: 'SGID'
  EksClusterSecurityGroupId:
    Type: Custom::CliQuery
    Properties:
      ServiceToken: !Sub ['arn:${AWS::Partition}:lambda:${AWS::Region}:${AWS::AccountId}:function:${Prefix}-ResourceReader', {Prefix: !FindInMap [Config, Prefix, Value]}]
      AwsCliCommand: !Sub "eks describe-cluster --name ${EKSClusterName} --query '{Id: cluster.resourcesVpcConfig.clusterSecurityGroupId}'"
      IdField: 'Id'
  KubernetesVersion:
    Type: Custom::CliQuery
    Properties:
      ServiceToken: !Sub ['arn:${AWS::Partition}:lambda:${AWS::Region}:${AWS::AccountId}:function:${Prefix}-ResourceReader', {Prefix: !FindInMap [Config, Prefix, Value]}]
      AwsCliCommand: !Sub "eks describe-cluster --name ${EKSClusterName} --query '{Version: cluster.version}'"
      IdField: 'Version'
  CleanupSecurityGroupDependencies:
    Type: Custom::Cleanup
    Properties:
      ServiceToken: !Sub ['arn:${AWS::Partition}:lambda:${AWS::Region}:${AWS::AccountId}:function:${Prefix}-CleanupSecurityGroupDependencies', {Prefix: !FindInMap [Config, Prefix, Value]}]
      SecurityGroups: !If [UseClusterNodeSecurityGroup, !Ref ClusterNodeSecurityGroup, !Ref NodeSecurityGroupId]
  ManagedASG:
    Condition: CreateManagedNodeGroup
    DependsOn: ManagedNodeGroup
    Type: Custom::CliQuery
    Properties:
      ServiceToken: !Sub ['arn:${AWS::Partition}:lambda:${AWS::Region}:${AWS::AccountId}:function:${Prefix}-ResourceReader', {Prefix: !FindInMap [Config, Prefix, Value]}]
      AwsCliCommand: !Sub "autoscaling describe-auto-scaling-groups --query 'AutoScalingGroups[? Tags[? Key==`eks:cluster-name` && Value==`${EKSClusterName}`] && Tags[? Key==`eks:nodegroup-name` && Value==`${ManagedNodeGroup.NodegroupName}`]] | [0] | {Id: AutoScalingGroupName}'"
      IdField: 'Id'
  NodeImageId:
    Condition: UseSSmAmi
    Type: Custom::CliQuery
    Properties:
      ServiceToken: !Sub ['arn:${AWS::Partition}:lambda:${AWS::Region}:${AWS::AccountId}:function:${Prefix}-ResourceReader', {Prefix: !FindInMap [Config, Prefix, Value]}]
      AwsCliCommand: !Sub
       - "ssm get-parameter --name '${ParamPath}' --query Parameter"
       - ParamPath: !If
         - IsAL2
         - !Sub
           - "/aws/service/eks/optimized-ami/${KubernetesVersion}/${OS}/recommended/image_id"
           - OS: !If [IsArm, 'amazon-linux-2-arm64', !If [IsGpu, 'amazon-linux-2-gpu', 'amazon-linux-2']]
         - !If
           - IsWindows
           - !Sub '/aws/service/ami-windows-latest/Windows_Server-${WindowsVersion}-English-${WindowsEdition}-EKS_Optimized-${KubernetesVersion}/image_id'
           - !If
             - IsBottlerocket
             - !Sub
               - '/aws/service/bottlerocket/aws-k8s-${KubernetesVersion}/${OS}/latest/image_id'
               - OS: !If [IsArm, 'arm64', 'x86_64']
             - !Ref 'AWS::NoValue'
      IdField: 'Value'
  UnmanagedASG:
    Type: AWS::AutoScaling::AutoScalingGroup
    Condition: CreateUnmanagedNodeGroup
    Properties:
      DesiredCapacity: !Ref NumberOfNodes
      MaxSize: !If [MaxNodesDefined, !Ref MaxNumberOfNodes, !Ref NumberOfNodes]
      MinSize: !Ref NumberOfNodes
      Tags:
        - Key: !Sub 'kubernetes.io/cluster/${EKSClusterName}'
          Value: 'owned'
          PropagateAtLaunch: true
        - Key: k8s.io/cluster-autoscaler/enabled
          Value: 'true'
          PropagateAtLaunch: true
        - Key: !Sub 'k8s.io/cluster-autoscaler/${EKSClusterName}'
          Value: ''
          PropagateAtLaunch: true
      VPCZoneIdentifier: !If
        - 3AZDeployment
        - [ !Ref Subnet1ID, !Ref Subnet2ID, !Ref Subnet3ID ]
        - !If
          - 2AZDeployment
          - [ !Ref Subnet1ID, !Ref Subnet2ID ]
          - [ !Ref Subnet1ID ]
      MixedInstancesPolicy:
        LaunchTemplate:
          LaunchTemplateSpecification:
            LaunchTemplateId: !If [CreateLaunchTemplate, !Ref NodeLaunchTemplate, !Ref LaunchTemplateId]
            Version: !If [CreateLaunchTemplate, !GetAtt NodeLaunchTemplate.LatestVersionNumber, !Ref LaunchTemplateVersion]
          Overrides: !If
            - 1Type
            - !Ref 'AWS::NoValue'
            - - InstanceType: !Ref NodeInstanceType
              - InstanceType: !If [2Type, !Ref NodeInstanceType2, !Ref 'AWS::NoValue']
              - InstanceType: !If [3Type, !Ref NodeInstanceType3, !Ref 'AWS::NoValue']
              - InstanceType: !If [4Type, !Ref NodeInstanceType4, !Ref 'AWS::NoValue']
        InstancesDistribution:
          OnDemandPercentageAboveBaseCapacity: !Ref OndemandPercentage
          SpotInstancePools: !If [1Type, 1, !If [2Type, 2, !If [3Type, 3, 4]]]
    CreationPolicy:
      ResourceSignal:
        !If
        - IsBottlerocket
        - !Ref 'AWS::NoValue'
        - Count: !Ref NumberOfNodes
          Timeout: PT15M
    UpdatePolicy:
      AutoScalingRollingUpdate:
        MinInstancesInService: !If [IsSingleInstance, 0, 1]
        MaxBatchSize: 1
        WaitOnResourceSignals: !If [IsBottlerocket, false, true]
        PauseTime: !If [IsBottlerocket, PT3M, PT15M]
  ManagedNodeGroup:
    Condition: CreateManagedNodeGroup
    Type: AWS::EKS::Nodegroup
    Properties:
      ClusterName: !Ref EKSClusterName
      LaunchTemplate:
        Id: !If [CreateLaunchTemplate, !Ref NodeLaunchTemplate, !Ref LaunchTemplateId]
        Version: !If [CreateLaunchTemplate, !GetAtt NodeLaunchTemplate.LatestVersionNumber, !Ref LaunchTemplateVersion]
      NodegroupName: !Ref NodeGroupName
      NodeRole: !Ref NodeRoleArn
      ScalingConfig:
        DesiredSize: !Ref NumberOfNodes
        MaxSize: !If [MaxNodesDefined, !Ref MaxNumberOfNodes, !Ref NumberOfNodes]
        MinSize: !Ref NumberOfNodes
      Subnets: !If
        - 3AZDeployment
        - [ !Ref Subnet1ID, !Ref Subnet2ID, !Ref Subnet3ID ]
        - !If
          - 2AZDeployment
          - [ !Ref Subnet1ID, !Ref Subnet2ID ]
          - [ !Ref Subnet1ID ]
  NodeLaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Condition: CreateNodeGroup
    Properties:
      LaunchTemplateData:
        BlockDeviceMappings:
          - DeviceName: /dev/xvda
            Ebs:
              VolumeSize: !Ref NodeVolumeSize
              VolumeType: gp2
              DeleteOnTermination: true
        IamInstanceProfile: !If [IsUnmanaged, {Arn: !Ref NodeInstanceProfileArn}, !Ref 'AWS::NoValue']
        KeyName: !If [UseKeyPair, !Ref KeyPairName, !Ref 'AWS::NoValue']
        NetworkInterfaces:
          - DeviceIndex: 0
            AssociatePublicIpAddress: false
            Description: String
            Groups:
              - !If [UseClusterNodeSecurityGroup, !Ref ClusterNodeSecurityGroup, !Ref NodeSecurityGroupId]
        ImageId: !If
          - UseCustomAmi
          - !Ref CustomAmiId
          - !Ref NodeImageId
        InstanceType: !Ref NodeInstanceType
        UserData:
          Fn::Base64: !If
            - IsWindows
            - !Sub
              - |
                <powershell>
                [string]$EKSBinDir = "$env:ProgramFiles\Amazon\EKS"
                [string]$EKSBootstrapScriptName = 'Start-EKSBootstrap.ps1'
                [string]$EKSBootstrapScriptFile = "$EKSBinDir\$EKSBootstrapScriptName"
                [string]$cfn_signal = "$env:ProgramFiles\Amazon\cfn-bootstrap\cfn-signal.exe"
                & $EKSBootstrapScriptFile -EKSClusterName ${EKSClusterName} -APIServerEndpoint ${ClusterEndpoint} -Base64ClusterCA  ${ClusterEndpoint.CaData} ${BootstrapArguments} 3>&1 4>&1 5>&1 6>&1
                $LastError = if ($?) { 0 } else { $Error[0].Exception.HResult }
                & $cfn_signal --exit-code=$LastError `
                --stack="${AWS::StackName}" `
                --resource="UnmanagedASG" `
                --region=${AWS::Region}
                </powershell>
              - BootstrapArguments: !If
                  - AddExtraArgs
                  - !Sub
                    - "-KubeletExtraArgs '${LabelsArg} ${TaintsArg}'"
                    - LabelsArg: !If [AddLabels, !Sub "--node-labels=${Labels}", ""]
                      TaintsArg: !If [AddTaints, !Sub "--register-with-taints=${Taints}", ""]
                  - ""
            - !If
              - IsBottlerocket
              - !Sub
                - |
                  [settings.kubernetes]
                  api-server = "${ClusterEndpoint}"
                  cluster-certificate = "${ClusterEndpoint.CaData}"
                  cluster-name = "${EKSClusterName}"
                  ${LabelsArg}
                  ${TaintsArg}
                - LabelsArg: !If
                    - AddLabels
                    - !Sub
                      - |
                        [settings.kubernetes.node-labels]
                        ${LabelPairs}
                      - LabelPairs: !Join [' = "', !Split ["=", !Join ["\"\n", !Split [",", !Sub '${Labels}"']]]]
                    - ""
                  TaintsArg: !If
                    - AddTaints
                    - !Sub
                      - |
                        [settings.kubernetes.node-labels]
                        ${TaintPairs}
                      - TaintPairs: !Join [' = "', !Split ["=", !Join ["\"\n", !Split [",", !Sub '${Taints}"']]]]
                    - ""
              - !Sub
                - |
                  #!/bin/bash
                  set -o xtrace
                  function signal() {
                    /opt/aws/bin/cfn-signal --exit-code $1 \
                      --stack  ${AWS::StackName} \
                      --resource UnmanagedASG  \
                      --region ${AWS::Region} \
                      --role ${NodeInstanceRoleName}
                  }
                  ${ProxySetup}
                  /etc/eks/bootstrap.sh ${EKSClusterName} ${ExtraArgs} \
                                    --b64-cluster-ca ${ClusterEndpoint.CaData} \
                                    --apiserver-endpoint ${ClusterEndpoint}  || signal 1
                  ${ProxyPostSetup}
                  signal $?
                - ExtraArgs: !If
                    - AddExtraArgs
                    - !Sub
                      - "--kubelet-extra-args '${LabelsArg} ${TaintsArg}'"
                      - LabelsArg: !If [AddLabels, !Sub "--node-labels=${Labels}", ""]
                        TaintsArg: !If [AddTaints, !Sub "--register-with-taints=${Taints}", ""]
                    - ""
                  ProxySetup: !If
                    - EnableProxy
                    - !Sub |
                      cat <<EOF >> /etc/environment
                      HTTP_PROXY=${HttpProxy}
                      HTTPS_PROXY=${HttpProxy}
                      http_proxy=${HttpProxy}
                      https_proxy=${HttpProxy}
                      no_proxy=${VPCCIDR},localhost,127.0.0.1,169.254.169.254,.internal
                      NO_PROXY=${VPCCIDR},localhost,127.0.0.1,169.254.169.254,.internal
                      EOF
                      set -a
                      source /etc/environment
                    - ""
                  ProxyPostSetup: !If
                    - EnableProxy
                    - |
                      mkdir -p /etc/systemd/system/docker.service.d
                      cat <<EOF >> /etc/systemd/system/docker.service.d/proxy.conf
                      [Service]
                      EnvironmentFile=/etc/environment
                      EOF
                      cat <<EOF >> /etc/systemd/system/kubelet.service.d/proxy.conf
                      [Service]
                      EnvironmentFile=/etc/environment
                      EOF
                      systemctl daemon-reload
                      systemctl enable --now --no-block docker
                      systemctl restart docker
                      systemctl restart kubelet
                    - ""
                  NodeInstanceRoleName: !Sub
                    - '${Prefix}-${Suffix}'
                    - Prefix: !FindInMap [Config, Prefix, Value]
                      Suffix: !If [IsManaged, 'ManagedNodeInstance', 'UnmanagedNodeInstance']
        MetadataOptions:
          HttpPutResponseHopLimit: !Ref EC2MetadataPutResponseHopLimit
          HttpEndpoint: enabled
          HttpTokens: !Ref EC2MetadataHttpTokens
Outputs:
  EKSNodeSecurityGroup:
    Value: !If [UseClusterNodeSecurityGroup, !Ref ClusterNodeSecurityGroup, !Ref NodeSecurityGroupId]
  NodeAutoScalingGroup:
    Condition: CreateNodeGroup
    Value: !If [IsManaged, !Ref ManagedASG, !Ref UnmanagedASG]
Rules:
  WindowsUnmanaged:
    Assertions:
      - Assert: !Not [!Equals [NodeGroupOS, 'Windows']]
        AssertDescription: "Managed nodegroups do not support Windows nodes."
    RuleCondition: !Equals
      - !Ref NodeGroupType
      - Managed
  ArmInstance:
    Assertions:
      - Assert: !Contains
          - - a1.medium
            - c6g.medium
            - c6gd.medium
            - m6g.medium
            - m6gd.medium
            - r6g.medium
            - a1.large
            - r6gd.medium
            - c6g.large
            - c6gd.large
            - m6g.large
            - m6gd.large
            - r6g.large
            - a1.xlarge
            - r6gd.large
            - c6g.xlarge
            - c6gd.xlarge
            - m6g.xlarge
            - m6gd.xlarge
            - r6g.xlarge
            - a1.2xlarge
            - r6gd.xlarge
            - c6g.2xlarge
            - c6gd.2xlarge
            - m6g.2xlarge
            - m6gd.2xlarge
            - r6g.2xlarge
            - a1.metal
            - a1.4xlarge
            - r6gd.2xlarge
            - c6g.4xlarge
            - c6gd.4xlarge
            - m6g.4xlarge
            - m6gd.4xlarge
            - r6g.4xlarge
            - r6gd.4xlarge
            - c6g.8xlarge
            - c6gd.8xlarge
            - m6g.8xlarge
            - m6gd.8xlarge
            - r6g.8xlarge
            - c6g.12xlarge
            - r6gd.8xlarge
            - c6gd.12xlarge
            - m6g.12xlarge
            - m6gd.12xlarge
            - c6g.16xlarge
            - c6g.metal
            - r6g.12xlarge
            - c6gd.metal
            - c6gd.16xlarge
            - m6g.metal
            - m6g.16xlarge
            - r6gd.12xlarge
            - m6gd.metal
            - m6gd.16xlarge
            - r6g.16xlarge
            - r6g.metal
            - r6gd.metal
            - r6gd.16xlarge
            - t4g.nano
            - t4g.medium
            - t4g.large
            - t4g.micro
            - t4g.small
            - t4g.2xlarge
            - t4g.xlarge
          - !Ref 'NodeInstanceType'
        AssertDescription: >-
          Valid instance types for the ARM instance family are: "a1.medium", "c6g.medium",
          "c6gd.medium", "m6g.medium", "m6gd.medium", "r6g.medium", "a1.large", "r6gd.medium",
          "c6g.large", "c6gd.large", "m6g.large", "m6gd.large", "r6g.large", "a1.xlarge",
          "r6gd.large", "c6g.xlarge", "c6gd.xlarge", "m6g.xlarge", "m6gd.xlarge",
          "r6g.xlarge", "a1.2xlarge", "r6gd.xlarge", "c6g.2xlarge", "c6gd.2xlarge",
          "m6g.2xlarge", "m6gd.2xlarge", "r6g.2xlarge", "a1.metal", "a1.4xlarge",
          "r6gd.2xlarge", "c6g.4xlarge", "c6gd.4xlarge", "m6g.4xlarge", "m6gd.4xlarge",
          "r6g.4xlarge", "r6gd.4xlarge", "c6g.8xlarge", "c6gd.8xlarge", "m6g.8xlarge",
          "m6gd.8xlarge", "r6g.8xlarge", "c6g.12xlarge", "r6gd.8xlarge", "c6gd.12xlarge",
          "m6g.12xlarge", "m6gd.12xlarge", "c6g.16xlarge", "c6g.metal", "r6g.12xlarge",
          "c6gd.metal", "c6gd.16xlarge", "m6g.metal", "m6g.16xlarge", "r6gd.12xlarge",
          "m6gd.metal", "m6gd.16xlarge", "r6g.16xlarge", "r6g.metal", "r6gd.metal",
          "r6gd.16xlarge", "t4g.nano", "t4g.medium", "t4g.large", "t4g.micro", "t4g.small",
          "t4g.2xlarge", "t4g.xlarge"
    RuleCondition: !Equals
      - !Ref NodeInstanceFamily
      - ARM
  GpuInstance:
    Assertions:
      - Assert: !Contains
          - - inf1.xlarge
            - inf1.2xlarge
            - inf1.6xlarge
            - inf1.24xlarge
            - g4dn.xlarge
            - g2.2xlarge
            - g3s.xlarge
            - g4dn.2xlarge
            - p2.xlarge
            - g3.4xlarge
            - g4dn.4xlarge
            - p3.8xlarge
            - p2.16xlarge
            - g4dn.8xlarge
            - g3.8xlarge
            - g2.8xlarge
            - p3.16xlarge
            - p3.2xlarge
            - g4dn.12xlarge
            - p3dn.24xlarge
            - g4dn.16xlarge
            - g3.16xlarge
            - p2.8xlarge
            - g4dn.metal
          - !Ref 'NodeInstanceType'
        AssertDescription: >-
          Valid instance types for the GPU instance family are: "inf1.xlarge", "inf1.2xlarge",
          "inf1.6xlarge", "inf1.24xlarge", "g4dn.xlarge", "g2.2xlarge", "g3s.xlarge",
          "g4dn.2xlarge", "p2.xlarge", "g3.4xlarge", "g4dn.4xlarge", "p3.8xlarge",
          "p2.16xlarge", "g4dn.8xlarge", "g3.8xlarge", "g2.8xlarge", "p3.16xlarge",
          "p3.2xlarge", "g4dn.12xlarge", "p3dn.24xlarge", "g4dn.16xlarge", "g3.16xlarge",
          "p2.8xlarge", "g4dn.metal"
    RuleCondition: !Equals
      - !Ref 'NodeInstanceFamily'
      - GPU
  StandardInstance:
    Assertions:
      - Assert: !Contains
          - - t3a.nano
            - t3.nano
            - t2.nano
            - t3a.micro
            - t3.micro
            - t2.micro
            - t3a.small
            - t1.micro
            - t3.small
            - t2.small
            - t3a.medium
            - t3.medium
            - m1.small
            - t2.medium
            - m3.medium
            - t3a.large
            - c5a.large
            - t3.large
            - c5.large
            - m5a.large
            - c5ad.large
            - m1.medium
            - t2.large
            - c5d.large
            - m5.large
            - c4.large
            - m4.large
            - m5ad.large
            - c3.large
            - c5n.large
            - m5d.large
            - r5a.large
            - m5n.large
            - r5.large
            - c1.medium
            - r5ad.large
            - m3.large
            - r4.large
            - m5dn.large
            - r5d.large
            - r5n.large
            - t3a.xlarge
            - c5a.xlarge
            - i3.large
            - r3.large
            - t3.xlarge
            - r5dn.large
            - c5.xlarge
            - c5ad.xlarge
            - m5a.xlarge
            - m1.large
            - t2.xlarge
            - z1d.large
            - m5.xlarge
            - c5d.xlarge
            - c4.xlarge
            - m4.xlarge
            - m5ad.xlarge
            - c3.xlarge
            - c5n.xlarge
            - r5a.xlarge
            - m5d.xlarge
            - i3en.large
            - m5n.xlarge
            - m2.xlarge
            - r5.xlarge
            - r5ad.xlarge
            - m3.xlarge
            - r4.xlarge
            - m5dn.xlarge
            - r5d.xlarge
            - r5n.xlarge
            - t3a.2xlarge
            - c5a.2xlarge
            - i3.xlarge
            - t3.2xlarge
            - r3.xlarge
            - r5dn.xlarge
            - c5.2xlarge
            - m5a.2xlarge
            - c5ad.2xlarge
            - m1.xlarge
            - inf1.xlarge
            - t2.2xlarge
            - z1d.xlarge
            - c5d.2xlarge
            - m5.2xlarge
            - c4.2xlarge
            - m4.2xlarge
            - m5ad.2xlarge
            - c3.2xlarge
            - c5n.2xlarge
            - r5a.2xlarge
            - m5d.2xlarge
            - i3en.xlarge
            - h1.2xlarge
            - m5n.2xlarge
            - m2.2xlarge
            - r5.2xlarge
            - c1.xlarge
            - r5ad.2xlarge
            - g4dn.xlarge
            - r4.2xlarge
            - m3.2xlarge
            - m5dn.2xlarge
            - r5d.2xlarge
            - inf1.2xlarge
            - r5n.2xlarge
            - c5a.4xlarge
            - i3.2xlarge
            - g2.2xlarge
            - r3.2xlarge
            - r5dn.2xlarge
            - c5.4xlarge
            - m5a.4xlarge
            - c5ad.4xlarge
            - d2.xlarge
            - z1d.2xlarge
            - g3s.xlarge
            - g4dn.2xlarge
            - c5d.4xlarge
            - m5.4xlarge
            - c4.4xlarge
            - m4.4xlarge
            - m5ad.4xlarge
            - x1e.xlarge
            - c3.4xlarge
            - i2.xlarge
            - c5n.4xlarge
            - p2.xlarge
            - r5a.4xlarge
            - i3en.2xlarge
            - m5d.4xlarge
            - h1.4xlarge
            - m5n.4xlarge
            - m2.4xlarge
            - r5.4xlarge
            - r5ad.4xlarge
            - r4.4xlarge
            - m5dn.4xlarge
            - z1d.3xlarge
            - g3.4xlarge
            - r5d.4xlarge
            - r5n.4xlarge
            - g4dn.4xlarge
            - c5a.8xlarge
            - i3.4xlarge
            - r3.4xlarge
            - r5dn.4xlarge
            - i3en.3xlarge
            - m5a.8xlarge
            - c5ad.8xlarge
            - d2.2xlarge
            - c5.9xlarge
            - m5.8xlarge
            - c4.8xlarge
            - m5ad.8xlarge
            - f1.2xlarge
            - x1e.2xlarge
            - c3.8xlarge
            - i2.2xlarge
            - c5d.9xlarge
            - m5d.8xlarge
            - r5a.8xlarge
            - c5a.12xlarge
            - h1.8xlarge
            - m5n.8xlarge
            - inf1.6xlarge
            - c5n.9xlarge
            - i3en.24xlarge
            - i3en.metal
            - p3.8xlarge
            - f1.16xlarge
            - x1.32xlarge
            - x1e.16xlarge
            - p2.16xlarge
            - m4.10xlarge
            - cc2.8xlarge
            - r5.8xlarge
            - c5.12xlarge
            - c5ad.12xlarge
            - m5a.12xlarge
            - r5ad.8xlarge
            - r4.8xlarge
            - m5dn.8xlarge
            - g4dn.8xlarge
            - z1d.6xlarge
            - g3.8xlarge
            - m5.12xlarge
            - c5d.12xlarge
            - r5d.8xlarge
            - r5n.8xlarge
            - c5a.16xlarge
            - m5ad.12xlarge
            - i3.8xlarge
            - g2.8xlarge
            - r3.8xlarge
            - r5dn.8xlarge
            - r5a.12xlarge
            - m5d.12xlarge
            - i3en.6xlarge
            - m5a.16xlarge
            - c5ad.16xlarge
            - d2.4xlarge
            - m5n.12xlarge
            - p3.16xlarge
            - x1e.32xlarge
            - r5.12xlarge
            - p3.2xlarge
            - c5.18xlarge
            - m5.16xlarge
            - r5ad.12xlarge
            - m4.16xlarge
            - m5dn.12xlarge
            - m5ad.16xlarge
            - f1.4xlarge
            - x1e.4xlarge
            - i2.4xlarge
            - c5d.18xlarge
            - r5d.12xlarge
            - r5n.12xlarge
            - m5d.16xlarge
            - r5a.16xlarge
            - c5a.24xlarge
            - h1.16xlarge
            - m5n.16xlarge
            - c5n.18xlarge
            - c5n.metal
            - g4dn.12xlarge
            - p3dn.24xlarge
            - r5dn.12xlarge
            - r5.16xlarge
            - c5.24xlarge
            - c5.metal
            - c5ad.24xlarge
            - m5a.24xlarge
            - r5ad.16xlarge
            - r4.16xlarge
            - m5dn.16xlarge
            - g4dn.16xlarge
            - z1d.metal
            - z1d.12xlarge
            - g3.16xlarge
            - m5.24xlarge
            - m5.metal
            - r5d.16xlarge
            - c5d.24xlarge
            - c5d.metal
            - r5n.16xlarge
            - m5ad.24xlarge
            - i3.16xlarge
            - i3.metal
            - r5dn.16xlarge
            - i3en.12xlarge
            - m5d.metal
            - m5d.24xlarge
            - r5a.24xlarge
            - d2.8xlarge
            - m5n.24xlarge
            - r5.24xlarge
            - r5.metal
            - r5ad.24xlarge
            - m5dn.24xlarge
            - x1.16xlarge
            - x1e.8xlarge
            - i2.8xlarge
            - r5d.24xlarge
            - r5d.metal
            - r5n.24xlarge
            - p2.8xlarge
            - inf1.24xlarge
            - g4dn.metal
            - r5dn.24xlarge
          - !Ref 'NodeInstanceType'
        AssertDescription: >-
          Valid instance types for the "Standard" instance family are: "t3a.nano",
          "t3.nano", "t2.nano", "t3a.micro", "t3.micro", "t2.micro", "t3a.small",
          "t1.micro", "t3.small", "t2.small", "t3a.medium", "t3.medium", "m1.small",
          "t2.medium", "m3.medium", "t3a.large", "c5a.large", "t3.large", "c5.large",
          "m5a.large", "c5ad.large", "m1.medium", "t2.large", "c5d.large", "m5.large",
          "c4.large", "m4.large", "m5ad.large", "c3.large", "c5n.large", "m5d.large",
          "r5a.large", "m5n.large", "r5.large", "c1.medium", "r5ad.large", "m3.large",
          "r4.large", "m5dn.large", "r5d.large", "r5n.large", "t3a.xlarge", "c5a.xlarge",
          "i3.large", "r3.large", "t3.xlarge", "r5dn.large", "c5.xlarge", "c5ad.xlarge",
          "m5a.xlarge", "m1.large", "t2.xlarge", "z1d.large", "m5.xlarge", "c5d.xlarge",
          "c4.xlarge", "m4.xlarge", "m5ad.xlarge", "c3.xlarge", "c5n.xlarge", "r5a.xlarge",
          "m5d.xlarge", "i3en.large", "m5n.xlarge", "m2.xlarge", "r5.xlarge", "r5ad.xlarge",
          "m3.xlarge", "r4.xlarge", "m5dn.xlarge", "r5d.xlarge", "r5n.xlarge", "t3a.2xlarge",
          "c5a.2xlarge", "i3.xlarge", "t3.2xlarge", "r3.xlarge", "r5dn.xlarge", "c5.2xlarge",
          "m5a.2xlarge", "c5ad.2xlarge", "m1.xlarge", "inf1.xlarge", "t2.2xlarge",
          "z1d.xlarge", "c5d.2xlarge", "m5.2xlarge", "c4.2xlarge", "m4.2xlarge", "m5ad.2xlarge",
          "c3.2xlarge", "c5n.2xlarge", "r5a.2xlarge", "m5d.2xlarge", "i3en.xlarge",
          "h1.2xlarge", "m5n.2xlarge", "m2.2xlarge", "r5.2xlarge", "c1.xlarge", "r5ad.2xlarge",
          "g4dn.xlarge", "r4.2xlarge", "m3.2xlarge", "m5dn.2xlarge", "r5d.2xlarge",
          "inf1.2xlarge", "r5n.2xlarge", "c5a.4xlarge", "i3.2xlarge", "g2.2xlarge",
          "r3.2xlarge", "r5dn.2xlarge", "c5.4xlarge", "m5a.4xlarge", "c5ad.4xlarge",
          "d2.xlarge", "z1d.2xlarge", "g3s.xlarge", "g4dn.2xlarge", "c5d.4xlarge",
          "m5.4xlarge", "c4.4xlarge", "m4.4xlarge", "m5ad.4xlarge", "x1e.xlarge",
          "c3.4xlarge", "i2.xlarge", "c5n.4xlarge", "p2.xlarge", "r5a.4xlarge", "i3en.2xlarge",
          "m5d.4xlarge", "h1.4xlarge", "m5n.4xlarge", "m2.4xlarge", "r5.4xlarge",
          "r5ad.4xlarge", "r4.4xlarge", "m5dn.4xlarge", "z1d.3xlarge", "g3.4xlarge",
          "r5d.4xlarge", "r5n.4xlarge", "g4dn.4xlarge", "c5a.8xlarge", "i3.4xlarge",
          "r3.4xlarge", "r5dn.4xlarge", "i3en.3xlarge", "m5a.8xlarge", "c5ad.8xlarge",
          "d2.2xlarge", "c5.9xlarge", "m5.8xlarge", "c4.8xlarge", "m5ad.8xlarge",
          "f1.2xlarge", "x1e.2xlarge", "c3.8xlarge", "i2.2xlarge", "c5d.9xlarge",
          "m5d.8xlarge", "r5a.8xlarge", "c5a.12xlarge", "h1.8xlarge", "m5n.8xlarge",
          "inf1.6xlarge", "c5n.9xlarge", "i3en.24xlarge", "i3en.metal", "p3.8xlarge",
          "f1.16xlarge", "x1.32xlarge", "x1e.16xlarge", "p2.16xlarge", "m4.10xlarge",
          "cc2.8xlarge", "r5.8xlarge", "c5.12xlarge", "c5ad.12xlarge", "m5a.12xlarge",
          "r5ad.8xlarge", "r4.8xlarge", "m5dn.8xlarge", "g4dn.8xlarge", "z1d.6xlarge",
          "g3.8xlarge", "m5.12xlarge", "c5d.12xlarge", "r5d.8xlarge", "r5n.8xlarge",
          "c5a.16xlarge", "m5ad.12xlarge", "i3.8xlarge", "g2.8xlarge", "r3.8xlarge",
          "r5dn.8xlarge", "r5a.12xlarge", "m5d.12xlarge", "i3en.6xlarge", "m5a.16xlarge",
          "c5ad.16xlarge", "d2.4xlarge", "m5n.12xlarge", "p3.16xlarge", "x1e.32xlarge",
          "r5.12xlarge", "p3.2xlarge", "c5.18xlarge", "m5.16xlarge", "r5ad.12xlarge",
          "m4.16xlarge", "m5dn.12xlarge", "m5ad.16xlarge", "f1.4xlarge", "x1e.4xlarge",
          "i2.4xlarge", "c5d.18xlarge", "r5d.12xlarge", "r5n.12xlarge", "m5d.16xlarge",
          "r5a.16xlarge", "c5a.24xlarge", "h1.16xlarge", "m5n.16xlarge", "c5n.18xlarge",
          "c5n.metal", "g4dn.12xlarge", "p3dn.24xlarge", "r5dn.12xlarge", "r5.16xlarge",
          "c5.24xlarge", "c5.metal", "c5ad.24xlarge", "m5a.24xlarge", "r5ad.16xlarge",
          "r4.16xlarge", "m5dn.16xlarge", "g4dn.16xlarge", "z1d.metal", "z1d.12xlarge",
          "g3.16xlarge", "m5.24xlarge", "m5.metal", "r5d.16xlarge", "c5d.24xlarge",
          "c5d.metal", "r5n.16xlarge", "m5ad.24xlarge", "i3.16xlarge", "i3.metal",
          "r5dn.16xlarge", "i3en.12xlarge", "m5d.metal", "m5d.24xlarge", "r5a.24xlarge",
          "d2.8xlarge", "m5n.24xlarge", "r5.24xlarge", "r5.metal", "r5ad.24xlarge",
          "m5dn.24xlarge", "x1.16xlarge", "x1e.8xlarge", "i2.8xlarge", "r5d.24xlarge",
          "r5d.metal", "r5n.24xlarge", "p2.8xlarge", "inf1.24xlarge", "g4dn.metal",
          "r5dn.24xlarge"
    RuleCondition: !Equals
      - !Ref 'NodeInstanceFamily'
      - Standard
